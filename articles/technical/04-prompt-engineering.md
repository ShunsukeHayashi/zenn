# 4. プロンプトエンジニアリング活用

## 4.1 効果的なプロンプト設計

### XMLタグの活用

Claude Codeを最大限に活用するためには、効果的なプロンプト設計が不可欠です。特に、XMLタグを使用した構造化されたプロンプトは、AIの理解を深め、より正確で期待通りの出力を得るための強力な手法となります。

Claude Codeは、XMLタグに対して特別な注意を払うように最適化されています。これは、単なるテキストの装飾ではなく、情報の意味的な構造を明確に伝えるための重要な仕組みです。例えば、コンテキスト情報、指示内容、期待する出力形式などを明確に区別することで、AIはユーザーの意図をより正確に理解することができます。

```xml
<context>
現在、Reactアプリケーションを開発しています。
ユーザー認証機能を実装中で、JWTトークンを使用しています。
バックエンドAPIはExpressで構築されています。
</context>

<task>
ログイン後のトークン管理を改善してください。
セキュリティを考慮し、リフレッシュトークンの仕組みを実装します。
</task>

<requirements>
- アクセストークンの有効期限: 15分
- リフレッシュトークンの有効期限: 7日
- トークンはlocalStorageではなく、httpOnlyクッキーで管理
- 自動更新メカニズムの実装
</requirements>
```

このようなXMLタグを使用したプロンプトは、単に「トークン管理を改善してください」という曖昧な指示よりも、はるかに具体的で実行可能な指示となります。各タグは特定の役割を持ち、AIがコンテキスト、タスク、要件を明確に区別して処理することを可能にします。

### 構造化された指示

効果的なプロンプト設計において、構造化は極めて重要な要素です。人間が複雑なタスクを理解する際に、情報を論理的に整理して提示されることを好むように、AIも構造化された情報をより効率的に処理することができます。

構造化されたプロンプトを作成する際の重要なポイントは、情報の階層化と関連性の明確化です。タスクを小さな単位に分解し、それぞれの関係性を明確にすることで、AIは全体像を把握しながら、個々の要素を適切に処理することができます。

```markdown
## プロジェクト: ECサイトの商品検索機能改善

### 現状の問題点
1. **検索速度の低下**
   - 商品数が10万件を超えてから顕著に
   - 特に複数条件での絞り込み時に問題

2. **検索精度の不足**
   - 類義語が考慮されていない
   - カテゴリーをまたいだ検索が困難

### 改善目標
1. **パフォーマンス目標**
   - 検索レスポンス時間: 200ms以下
   - 同時接続数: 1000ユーザー対応

2. **機能目標**
   - 類義語辞書の実装
   - ファセット検索の導入
   - 検索履歴に基づくサジェスト機能

### 実装方針
以下の順序で段階的に実装してください：

1. **第1フェーズ: インデックス最適化**
   - Elasticsearchの導入検討
   - 既存DBとの連携設計

2. **第2フェーズ: 検索アルゴリズム改善**
   - 形態素解析の導入
   - スコアリングロジックの最適化

3. **第3フェーズ: UI/UX改善**
   - リアルタイム検索の実装
   - 検索結果の視覚的改善
```

このような構造化されたプロンプトは、AIに対して明確な実行計画を提供します。問題の背景、目標、そして具体的な実装ステップが論理的に整理されているため、AIは各段階で何を達成すべきかを正確に理解し、適切なソリューションを提供することができます。

### コンテキスト提供

コンテキストの提供は、Claude Codeとの効果的なコミュニケーションにおいて最も重要な要素の一つです。適切なコンテキストがあれば、AIはより的確で、プロジェクトの文脈に即した回答を提供することができます。

コンテキストとは単なる背景情報ではありません。それは、現在の状況、制約条件、期待される成果、そして過去の決定事項など、タスクを適切に実行するために必要なすべての情報を包含します。優れたコンテキスト提供は、AIとの対話を単なる質問応答から、真の協働作業へと昇華させます。

```markdown
# コンテキスト: マイクロサービス移行プロジェクト

## プロジェクト背景
当社のモノリシックなRailsアプリケーションは、5年間の開発を経て
巨大化し、以下の問題に直面しています：
- デプロイに30分以上かかる
- 一部の機能変更が全体に影響を与える
- スケーリングが困難

## 現在の技術スタック
- Ruby on Rails 6.1
- PostgreSQL 12
- Redis (キャッシュ、セッション管理)
- Sidekiq (バックグラウンドジョブ)
- Docker (開発環境のみ)

## チーム構成
- バックエンドエンジニア: 5名
- フロントエンドエンジニア: 3名
- インフラエンジニア: 2名
- 全員がマイクロサービス経験は限定的

## 制約条件
- サービス停止は最大2時間まで
- 既存のAPIクライアントとの後方互換性必須
- 予算: 月額インフラコスト20%増まで許容

## 期待される成果
- 各サービスの独立したデプロイが可能
- 水平スケーリングの実現
- 障害の影響範囲を限定化

このコンテキストを踏まえて、段階的な移行計画を立案してください。
```

このような詳細なコンテキスト提供により、Claude Codeは単に技術的に正しい答えを返すだけでなく、組織の実情に即した実践的なソリューションを提案することができます。チームのスキルレベル、予算制約、ビジネス要件などを考慮に入れた、真に実行可能な計画を作成することが可能になります。

## 4.2 非プログラミングコンテンツ生成

### ドキュメント作成

Claude Codeの活用範囲は、純粋なコーディング作業をはるかに超えています。特にドキュメント作成においては、その自然言語処理能力と構造化思考が大きな価値を発揮します。技術ドキュメントからビジネス文書まで、幅広い文書作成タスクを効率化することができます。

現代のソフトウェア開発において、優れたドキュメントは製品の成功に不可欠な要素です。しかし、多くの開発者にとって、ドキュメント作成は時間がかかり、しばしば後回しにされがちなタスクです。Claude Codeは、コードベースを理解し、その知識を基に包括的で正確なドキュメントを生成することで、この課題を解決します。

```bash
claude "プロジェクトのREADME.mdを作成してください。
以下の要素を含めてください：
- プロジェクトの概要と目的
- 主要な機能
- 技術スタック
- セットアップ手順
- 使用方法の例
- コントリビューションガイドライン
- ライセンス情報

トーンは親しみやすく、でも専門的に。
開発者が最初に見るドキュメントとして、
プロジェクトに参加したくなるような内容にしてください。"
```

API ドキュメントの生成においても、Claude Codeは強力なアシスタントとなります。コードからドキュメントを自動生成するだけでなく、使用例、エラーハンドリング、ベストプラクティスなども含めた、開発者にとって真に有用なドキュメントを作成することができます。

```bash
claude "src/api/ディレクトリのすべてのエンドポイントを分析して、
OpenAPI 3.0仕様のドキュメントを生成してください。
各エンドポイントについて：
- リクエスト/レスポンスの例
- 認証要件
- エラーコード一覧
- レート制限情報
を含めてください。

また、PostmanやInsomniaで直接インポートできる
コレクションファイルも生成してください。"
```

### レポート生成

データ分析やプロジェクト進捗のレポート作成は、多くの専門職にとって避けられない業務です。Claude Codeは、生データから洞察を抽出し、それを読みやすく、アクションにつながるレポートとして構成する能力を持っています。

定期的なレポート作成において、Claude Codeは単なるテンプレートの穴埋めを超えた価値を提供します。データのトレンドを分析し、異常値を検出し、それらを文脈化して説明することができます。さらに、レポートの読者に応じて、技術的な詳細レベルを調整することも可能です。

```bash
claude "先月のウェブサイトアクセスログ（access_log_202501.csv）を分析して、
月次パフォーマンスレポートを作成してください。

レポートには以下を含めてください：
1. エグゼクティブサマリー（1ページ）
   - 主要KPIの変化
   - 重要な発見事項3つ
   - 推奨アクション

2. 詳細分析
   - トラフィックパターンの分析
   - ページ別パフォーマンス
   - ユーザー行動の変化
   - 技術的問題の特定

3. 前月比較と傾向分析
   - 成長指標
   - 懸念事項
   - 予測

マーケティングチームと技術チームの両方が理解できるよう、
専門用語には説明を付けてください。"
```

週次の進捗レポートや、スプリントレビューのためのレポート生成においても、Claude Codeは開発者の負担を大幅に軽減します。Gitのコミット履歴、タスク管理ツールのデータ、テスト結果などを統合して、包括的な進捗レポートを自動生成することができます。

### 企画書作成

新しいプロジェクトや機能の提案において、説得力のある企画書は成功の鍵となります。Claude Codeは、技術的な実現可能性と、ビジネス価値の両面を考慮した企画書の作成を支援します。

効果的な企画書には、明確な問題定義、実現可能な解決策、期待される成果、そして実装計画が含まれている必要があります。Claude Codeは、これらの要素を論理的に構成し、読者を説得するストーリーとして組み立てることができます。

```bash
claude "社内の技術的負債を解消するためのプロジェクト企画書を作成してください。

現状の課題：
- レガシーコードが全体の40%を占める
- テストカバレッジが30%未満
- デプロイプロセスが手動で、エラーが頻発
- 新機能開発の速度が低下

企画書に含める内容：
1. エグゼクティブサマリー
2. 現状分析と問題の定量化
3. 提案するソリューション
4. 実装ロードマップ（6ヶ月）
5. 必要なリソース
6. ROI分析
7. リスクと軽減策
8. 成功指標

経営層向けのプレゼンテーションとして、
ビジネスインパクトを強調してください。"
```

## 4.3 高度なテクニック

### Few-shotプロンプティング

Few-shotプロンプティングは、AIに期待する出力の具体例を提供することで、より精確で一貫性のある結果を得るための高度なテクニックです。この手法は、特に独自のコーディング規約や、特定のドキュメントフォーマットに従う必要がある場合に威力を発揮します。

Few-shotプロンプティングの本質は、「説明するよりも示す」ことにあります。抽象的なルールを長々と説明するよりも、具体的な例を2〜3個示すことで、AIはパターンを理解し、それに従った出力を生成することができます。

```bash
claude "以下の例に従って、新しいReactコンポーネントのテストを書いてください。

例1: Buttonコンポーネント
\`\`\`typescript
describe('Button', () => {
  it('should render with correct text', () => {
    const { getByText } = render(<Button>Click me</Button>);
    expect(getByText('Click me')).toBeInTheDocument();
  });

  it('should call onClick handler when clicked', () => {
    const handleClick = jest.fn();
    const { getByRole } = render(
      <Button onClick={handleClick}>Click me</Button>
    );
    fireEvent.click(getByRole('button'));
    expect(handleClick).toHaveBeenCalledTimes(1);
  });

  it('should be disabled when disabled prop is true', () => {
    const { getByRole } = render(
      <Button disabled>Click me</Button>
    );
    expect(getByRole('button')).toBeDisabled();
  });
});
\`\`\`

例2: InputFieldコンポーネント
\`\`\`typescript
describe('InputField', () => {
  it('should render with placeholder', () => {
    const { getByPlaceholderText } = render(
      <InputField placeholder=\"Enter text\" />
    );
    expect(getByPlaceholderText('Enter text')).toBeInTheDocument();
  });

  it('should update value on change', () => {
    const { getByRole } = render(<InputField />);
    const input = getByRole('textbox');
    fireEvent.change(input, { target: { value: 'test value' } });
    expect(input).toHaveValue('test value');
  });

  it('should show error message when validation fails', () => {
    const { getByText } = render(
      <InputField error=\"Required field\" />
    );
    expect(getByText('Required field')).toBeInTheDocument();
  });
});
\`\`\`

これらの例を参考に、SelectDropdownコンポーネントのテストを書いてください。
コンポーネントは複数選択、検索機能、無効化状態をサポートしています。"
```

このアプローチにより、Claude Codeは提示されたテストの構造、命名規則、テストケースの選択基準を理解し、同じパターンに従った新しいテストを生成します。結果として、プロジェクト全体で一貫性のあるテストコードが維持されます。

### プロンプトチェイン

プロンプトチェインは、複雑なタスクを連続した小さなステップに分解し、各ステップの出力を次のステップの入力として使用する高度な技法です。この手法により、AIの推論能力を最大限に活用し、より複雑で洗練された成果物を生成することができます。

プロンプトチェインの力は、段階的な改善と検証にあります。各ステップで中間成果物を生成し、それを検証・改善しながら最終的な目標に向かって進むことで、エラーの累積を防ぎ、品質の高い最終成果物を得ることができます。

```bash
# ステップ1: 要件分析
claude "ユーザー管理システムの要件を分析してください。
以下の情報から、機能要件と非機能要件を整理してください：
- ユーザー登録、ログイン、プロフィール管理
- 管理者による一括ユーザー管理
- OAuth2.0対応
- 10万ユーザー規模での運用
- GDPR準拠"

# ステップ2: アーキテクチャ設計
claude "先ほど整理した要件に基づいて、
システムアーキテクチャを設計してください。
マイクロサービスアーキテクチャを採用し、
各サービスの責務を明確にしてください。"

# ステップ3: データモデル設計
claude "設計したアーキテクチャに基づいて、
各サービスのデータモデルを設計してください。
正規化とパフォーマンスのバランスを考慮し、
インデックス戦略も含めてください。"

# ステップ4: API設計
claude "データモデルを基に、RESTful APIを設計してください。
エンドポイント、リクエスト/レスポンス形式、
認証フロー、エラーハンドリングを含めてください。"

# ステップ5: 実装計画
claude "これまでの設計を基に、実装計画を作成してください。
フェーズ分け、各フェーズの成果物、
必要なリソース、タイムラインを含めてください。"
```

### 思考レベル調整

Claude Codeには、タスクの複雑さに応じて思考の深さを調整する独自の機能があります。「think」というキーワードを使用することで、AIにより深い分析と検討を促すことができます。この機能は、特に複雑な問題解決や、創造的なソリューションが必要な場面で有効です。

思考レベルの調整は、単なる処理時間の延長ではありません。より高い思考レベルでは、AIは複数の代替案を検討し、それぞれのトレードオフを評価し、最適なソリューションを選択するプロセスを経ます。これは、人間のエキスパートが重要な決定を下す際のプロセスに似ています。

```bash
# 基本レベル
claude "ユーザー認証システムを実装してください"

# 思考レベル1: think
claude "think: ユーザー認証システムを実装してください。
セキュリティのベストプラクティスを考慮してください。"

# 思考レベル2: think hard
claude "think hard: 金融機関向けのユーザー認証システムを設計してください。
規制要件、脅威モデル、ユーザビリティのバランスを
慎重に検討してください。"

# 思考レベル3: think harder
claude "think harder: 量子コンピュータ時代を見据えた
次世代認証システムのアーキテクチャを提案してください。
現在の技術的制約と、将来の技術進化を考慮して、
10年後も安全性を保てる設計にしてください。"

# 最高レベル: ultrathink
claude "ultrathink: 分散型アイデンティティ管理システムの
完全な設計と実装計画を作成してください。
ブロックチェーン、ゼロ知識証明、生体認証を統合し、
プライバシーと利便性を両立させる革新的なソリューションを
提案してください。"
```

各思考レベルでは、AIの分析の深さと創造性が段階的に向上します。簡単なタスクには低い思考レベルで十分ですが、革新的なソリューションや、複雑なトレードオフを伴う決定には、より高い思考レベルが適しています。

思考レベルの適切な選択は、タスクの重要性と緊急性のバランスによって決まります。日常的なコーディングタスクには基本レベルで十分ですが、アーキテクチャの決定や、長期的な影響を持つ設計選択には、より高い思考レベルを使用することが推奨されます。

---

次章では、Claude Codeを使用したワークフロー自動化とDX（Developer Experience）の向上について詳しく解説します。カスタムコマンドの作成から、Hooks機能による自動化、そして他ツールとの連携まで、開発プロセス全体を効率化する方法を探っていきます。